<script>
// ---- Guard against accidental double load
if (window.MM_QUOTE_INIT_DONE) {
  console.warn('Move Motorcycles Quote: duplicate script ignored.');
} else {
  window.MM_QUOTE_INIT_DONE = true;

document.addEventListener('DOMContentLoaded',()=>{

  /* ========= CONFIG ========= */
  const SUBMIT_ENDPOINT = "https://formspree.io/f/xldoyvpk";
  const RECIPIENT_EMAIL = "quotes@movemotorcycles.co.uk";

  /* ========= HELPERS ========= */
  const money = n => '£'+Number(n).toLocaleString();
  const makeRange=(a,b)=>{const r=[];for(let i=a;i<=b;i++)r.push(i);return r;};

  /* ========= GET DOM ========= */
  const selOrigin  = document.getElementById('sel-origin');
  const selDest    = document.getElementById('sel-dest');
  const selVehicle = document.getElementById('sel-vehicle');
  const selPX      = document.getElementById('sel-px');
  const deliveryEl = document.getElementById('delivery');
  const pxEl       = document.getElementById('pxVal');
  const totalEl    = document.getElementById('total');
  const errEl      = document.getElementById('err');
  const custName   = document.getElementById('custName');
  const custEmail  = document.getElementById('custEmail');
  const custMobile = document.getElementById('custMobile');
  const notesEl    = document.getElementById('notes');
  const formErr    = document.getElementById('formErr');
  const copyNotice = document.getElementById('copyNotice');

  // Hard guard: if key elements aren’t found, stop.
  if(!selOrigin || !selDest || !selVehicle || !selPX){
    console.error('Quote widget: missing selects. Check IDs.');
    if (errEl){ errEl.textContent='There was a problem initialising the dropdowns.'; errEl.style.display='block'; }
    return;
  }

  /* ========= DATA: “Ask” zones + Seeds (Large) ========= */
  const ASK_ZONES = new Set([25,26,28,29,30,31]); // delivery “Ask” only

  const PRICE_SEEDS = [
    // South (1) ↔ South (2–10)
    {cat:"Large",from:[1],to:[2,3,4,5,6,7,8,9,10],price:229},
    {cat:"Large",from:[2,3,4,5,6,7,8,9,10],to:[1],price:229},

    // South (1) ↔ North band (11–19)
    {cat:"Large",from:[1],to:[11,12,13,14,15,16,17,18,19],price:249},
    {cat:"Large",from:[11,12,13,14,15,16,17,18,19],to:[1],price:249},

    // South (1) ↔ 20 / 22 / 23 / 24
    {cat:"Large",from:[1],to:[20],price:249},{cat:"Large",from:[20],to:[1],price:249},
    {cat:"Large",from:[1],to:[22],price:289},{cat:"Large",from:[22],to:[1],price:289},
    {cat:"Large",from:[1],to:[23],price:349},{cat:"Large",from:[23],to:[1],price:349},
    {cat:"Large",from:[1],to:[24],price:389},{cat:"Large",from:[24],to:[1],price:389},

    // South band (2–10) → North
    {cat:"Large",from:makeRange(2,10),to:[11],price:249},
    {cat:"Large",from:makeRange(2,10),to:makeRange(12,16),price:229},
    {cat:"Large",from:makeRange(2,10),to:makeRange(17,19),price:229},
    {cat:"Large",from:makeRange(2,10),to:[20],price:249},
    {cat:"Large",from:makeRange(2,10),to:[22],price:289},
    {cat:"Large",from:makeRange(2,10),to:[23],price:349},
    {cat:"Large",from:makeRange(2,10),to:[24],price:389},

    // North → South band (2–10) mirrors
    {cat:"Large",from:[11],to:[2,3,4,5,6,7,8,9,10],price:249},
    {cat:"Large",from:[12,13,14,15,16],to:[2,3,4,5,6,7,8,9,10],price:229},
    {cat:"Large",from:[17,18,19],to:[2,3,4,5,6,7,8,9,10],price:229},
    {cat:"Large",from:[20],to:[2,3,4,5,6,7,8,9,10],price:249},
    {cat:"Large",from:[22],to:[2,3,4,5,6,7,8,9,10],price:289},
    {cat:"Large",from:[23],to:[2,3,4,5,6,7,8,9,10],price:349},
    {cat:"Large",from:[24],to:[2,3,4,5,6,7,8,9,10],price:389},

    // Specific specials agreed earlier
    {cat:"Large",from:[11],to:[20],price:229},{cat:"Large",from:[20],to:[11],price:229},
    {cat:"Large",from:[11],to:[23],price:349},{cat:"Large",from:[23],to:[11],price:349},
    {cat:"Large",from:[11],to:[24],price:349},{cat:"Large",from:[24],to:[11],price:349},
    {cat:"Large",from:[12],to:[14,17],price:229},{cat:"Large",from:[14,17],to:[12],price:229},
  ];

  /* ========= PX rules ========= */
  const PX_FLAT = 109;
  const PX_SCOTLAND = 159; // deliver to zones 20–24

  /* ========= PRICE GUARDRAILS (Floors & Adjustments) ========= */
  // Floors by gap band (|from-to|): 0–1, 2–4, 5–8, 9–15, 16+
  const FLOOR_BANDS = {
    small:  [109, 139, 169, 209, 239],
    medium: [129, 159, 189, 229, 259],
    large:  [149, 179, 209, 249, 279],
    xlarge: [179, 209, 239, 279, 309],
    quads:  [399, 429, 469, 509, 549],  // unchanged
    trikes: [519, 558, 609, 662, 714],  // ~30% above quads
  };

  // Destination-specific minimums (lift if below)
  const DEST_ZONE_FLOORS = {
    20: 249, 21: 259, 22: 289, 23: 349, 24: 389
  };

  // Simple per-pair numeric override/uplift (applies to all cats unless category map exists)
  const PER_PAIR_ADJUST = {
    // "2>14": { override: 239 },
    // "9>20": { uplift: 20 },
  };

  // NEW: Category-specific per-pair overrides (takes precedence over floors, seeds & PER_PAIR_ADJUST)
  const PER_PAIR_OVERRIDE_BY_CAT = {
    // Bumped 12 ↔ 16
    "12>16": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 },
    "16>12": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 },
    // Nearby smoothing rings: 11 ↔ 16 and 12 ↔ 15
    "11>16": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 },
    "16>11": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 },
    "12>15": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 },
    "15>12": { "Small":219, "Medium":229, "Large":249, "Extra Large":279 }
  };

  /* ========= PRICING CORE ========= */
  function gapPriceSmall(g){ if(g<=1)return 99; if(g<=4)return 129; if(g<=8)return 159; if(g<=15)return 199; return 229; }
  function gapPriceQuads(g){ const bands=[399,429,469,509,549]; if(g<=1)return bands[0]; if(g<=4)return bands[1]; if(g<=8)return bands[2]; if(g<=15)return bands[3]; return bands[4]; }
  function lookupPX(from,to){ return new Set([20,21,22,23,24]).has(to) ? PX_SCOTLAND : PX_FLAT; }

  function getSeedsFor(cat){
    const L = PRICE_SEEDS;
    if(cat==='Large') return L;
    if(cat==='Medium') return L.map(s=>({cat:'Medium',from:s.from,to:s.to,price:s.price-20}));
    if(cat==='Small')  return L.map(s=>({cat:'Small', from:s.from,to:s.to,price:s.price-30}));
    if(cat==='Extra Large') return L.map(s=>({cat:'Extra Large',from:s.from,to:s.to,price:s.price+30}));
    return [];
  }

  function findSeedPrice(cat,from,to){
    const seeds = getSeedsFor(cat);
    for(const s of seeds){
      const froms = Array.isArray(s.from)? s.from : [s.from];
      const tos   = Array.isArray(s.to)? s.to : [s.to];
      const fm = froms.some(v => Array.isArray(v)? v.includes(from) : v===from);
      const tm = tos.some(v => Array.isArray(v)? v.includes(to)   : v===to);
      if(fm && tm) return s.price;
    }
    return null;
  }

  function catKey(cat){
    if(cat==='Small') return 'small';
    if(cat==='Medium') return 'medium';
    if(cat==='Large') return 'large';
    if(cat==='Extra Large') return 'xlarge';
    if(cat==='Quads') return 'quads';
    if(cat==='Trikes') return 'trikes';
    return 'large';
  }
  function bandIndex(gap){
    if (gap<=1) return 0;
    if (gap<=4) return 1;
    if (gap<=8) return 2;
    if (gap<=15) return 3;
    return 4;
  }

  // Baseline model (before floors/overrides)
  function baselineDelivery(cat,from,to){
    const g = Math.abs(from-to), largeBase = gapPriceSmall(g)+40;
    if(cat==='Small') return largeBase-30;
    if(cat==='Medium') return largeBase-20;
    if(cat==='Large') return largeBase;
    if(cat==='Extra Large') return largeBase+30;
    if(cat==='Quads') return gapPriceQuads(g);
    if(cat==='Trikes') return Math.round(gapPriceQuads(g)*1.30);
    return 0;
  }

  // Apply floors & overrides
  function applyFloorsAndAdjust(cat, from, to, price){
    // Category-specific per-pair override (highest precedence)
    const catMap = PER_PAIR_OVERRIDE_BY_CAT[`${from}>${to}`];
    if (catMap && Object.prototype.hasOwnProperty.call(catMap, cat)) {
      return catMap[cat];
    }

    let p = price;

    // 1) Band floor by gap & category
    const gap = Math.abs(from-to);
    const bi  = bandIndex(gap);
    const fk  = catKey(cat);
    const bandFloors = FLOOR_BANDS[fk] || [];
    const bandMin = bandFloors[bi] ?? 0;
    if (typeof p === 'number' && p < bandMin) p = bandMin;

    // 2) Destination-specific floor
    const destMin = DEST_ZONE_FLOORS[to];
    if (typeof destMin === 'number' && typeof p === 'number' && p < destMin) p = destMin;

    // 3) Simple per-pair override/uplift (non-category)
    const key = `${from}>${to}`;
    const adj = PER_PAIR_ADJUST[key];
    if (adj && typeof adj.override === 'number') return adj.override;
    if (adj && typeof adj.uplift === 'number' && typeof p === 'number') p += adj.uplift;

    return p;
  }

  function lookupDelivery(cat,from,to){
    if(ASK_ZONES.has(from)||ASK_ZONES.has(to)) return 'Ask';
    const seeded = findSeedPrice(cat,from,to);
    let price = (seeded!=null) ? seeded : baselineDelivery(cat,from,to);
    if (price !== 'Ask') price = applyFloorsAndAdjust(cat, from, to, price);
    return price;
  }

  /* ========= POPULATE + WIRE ========= */
  function fillZones(select){
    select.innerHTML='';
    for(let z=1; z<=31; z++){ select.add(new Option(`Zone ${z}`, String(z))); }
  }
  fillZones(selOrigin);
  fillZones(selDest);
  selOrigin.value='1';
  selDest.value='1';

  function calc(){
    try{
      const from = parseInt(selOrigin.value,10);
      const to   = parseInt(selDest.value,10);
      if(!Number.isFinite(from)||!Number.isFinite(to)) return;
      const cat  = selVehicle.value;
      const px   = selPX.value;

      const delivery = lookupDelivery(cat,from,to);
      const pxAdd    = (px==='Yes') ? lookupPX(from,to) : 0;

      if(delivery==='Ask'){
        deliveryEl.textContent='Ask';
        pxEl.textContent = (px==='Yes')?money(pxAdd):'£0';
        totalEl.textContent='Ask';
      }else{
        deliveryEl.textContent = money(delivery);
        pxEl.textContent       = (px==='Yes')?money(pxAdd):'£0';
        totalEl.textContent    = money(delivery+pxAdd);
      }
      if(errEl) errEl.style.display='none';
    }catch(e){
      console.error(e);
      if(errEl){ errEl.textContent='There was a problem calculating the price.'; errEl.style.display='block'; }
    }
  }

  selOrigin.addEventListener('change',calc);
  selDest.addEventListener('change',calc);
  selVehicle.addEventListener('change',calc);
  selPX.addEventListener('change',calc);
  calc(); // first render

  /* ========= SUBMIT (Formspree) ========= */
  document.getElementById('btnEmail')?.addEventListener('click', async (ev)=>{
    ev?.preventDefault?.(); ev?.stopPropagation?.();

    const name   = custName.value.trim();
    const email  = custEmail.value.trim();
    const mobile = custMobile.value.trim();
    const validEmail  = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const validMobile = mobile.replace(/\D/g,'').length >= 10;

    if(!name || !email || !mobile || !validEmail || !validMobile){
      formErr.textContent='Please complete Your Name, a valid Email and Mobile number before sending.';
      formErr.style.display='block';
      ( !name ? custName : !validEmail ? custEmail : custMobile ).focus();
      return;
    } else formErr.style.display='none';

    const subject = `Move Motorcycles Quote — Zone ${selOrigin.value} → Zone ${selDest.value} (${selVehicle.value})`;
    const bodyText = [
      'Move Motorcycles — Quote Request','',
      `Collect from (Zone): ${selOrigin.value}`,
      `Deliver to (Zone): ${selDest.value}`,
      `Vehicle Type: ${selVehicle.value}`,
      `Part Exchange: ${selPX.value}`,
      `Delivery: ${deliveryEl.textContent || ''}`,
      `PX Add-On: ${pxEl.textContent || ''}`,
      `Total: ${totalEl.textContent || ''}`,'',
      `Customer Name: ${name}`,
      `Customer Email: ${email}`,
      `Customer Mobile: ${mobile}`,'',
      'Customer Notes:', (notesEl.value || '(none)')
    ].join('\n');

    try{
      const res = await fetch(SUBMIT_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({
          _subject: subject,
          _replyto: email,
          message: bodyText,
          recipient: RECIPIENT_EMAIL,
          origin_zone: selOrigin.value,
          destination_zone: selDest.value,
          vehicle_type: selVehicle.value,
          part_exchange: selPX.value,
          delivery_price: deliveryEl.textContent || '',
          px_addon: pxEl.textContent || '',
          total_price: totalEl.textContent || '',
          customer_name: name,
          customer_email: email,
          customer_mobile: mobile,
          notes: notesEl.value || ''
        })
      });

      if(res.ok){
        formErr.style.display='none';
        if(copyNotice){
          copyNotice.style.display='block';
          copyNotice.style.color='#A4E8A2';
          copyNotice.textContent='✅ Sent! We’ll email you shortly to confirm availability.';
        } else {
          alert('Sent! We’ll email you shortly to confirm availability.');
        }
      }else{
        const txt = await res.text();
        throw new Error('Submit failed: '+txt);
      }
    }catch(e){
      console.error(e);
      if(copyNotice){
        copyNotice.style.display='block';
        copyNotice.style.color='#FFD580';
        copyNotice.textContent='❌ Sorry — couldn’t send just now. Please try again in a moment.';
      } else {
        alert('Sorry — couldn’t send just now. Please try again in a moment.');
      }
    }
  });

  /* ========= Optional: quick console debug to see lifts ========= */
  window.MM_debugFloors = function(cat='Large'){
    const rows=[];
    for(let f=1; f<=31; f++){
      for(let t=1; t<=31; t++){
        if (ASK_ZONES.has(f) || ASK_ZONES.has(t)) continue;
        const base = (findSeedPrice(cat,f,t) ?? baselineDelivery(cat,f,t));
        const fixed = applyFloorsAndAdjust(cat,f,t, base);
        if (typeof base==='number' && typeof fixed==='number' && fixed>base){
          rows.push({cat,from:f,to:t,base,fixed,delta:fixed-base});
        }
      }
    }
    console.table(rows);
  };

}); // DOMContentLoaded

} // end guard
</script>
